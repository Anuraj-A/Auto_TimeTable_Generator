<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generated Timetable</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Montserrat:wght@700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* --- CSS Variables for consistent theming --- */
        :root {
            --primary-color: #4A90E2; /* Modern Blue */
            --primary-dark: #357ABD;
            --secondary-color: #6c757d;
            --background-light: #F4F7FC; /* Very light, soft background */
            --background-card: #ffffff; /* White for content cards */
            --text-dark: #34495E; /* Darker, sophisticated text */
            --text-light: #ffffff;
            --border-color: #DDE2EC; /* Softer border */
            --success-bg: #D4EDDA;
            --success-text: #155724;
            --error-bg: #f8d7da; /* Light red for errors */
            --error-text: #721c24; /* Dark red for errors */
            --border-radius-sm: 6px;
            --border-radius-md: 10px;
            --card-shadow: rgba(0, 0, 0, 0.08); /* Lighter, subtle shadow */
            --transition-speed: 0.3s;

            /* Specific timetable colors */
            --timetable-header-bg: var(--primary-color);
            --timetable-header-text: var(--text-light);
            --timetable-row-even-bg: var(--background-light);
            --timetable-row-hover-bg: #EBF2FA;
            --timetable-cell-border: var(--border-color);
        }

        /* --- Global Body Styling --- */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--background-light);
            color: var(--text-dark);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
            line-height: 1.6;
        }

        /* --- Container for the Timetable --- */
        .timetable-container {
            max-width: 1200px;
            width: 95%;
            background-color: var(--background-card);
            padding: 40px;
            border-radius: var(--border-radius-md);
            box-shadow: 0 8px 25px var(--card-shadow);
            margin-top: 30px;
            margin-bottom: 30px;
            box-sizing: border-box;
        }

        /* --- Heading Style --- */
        h1 {
            text-align: center;
            font-family: 'Montserrat', sans-serif;
            color: var(--primary-color);
            margin-bottom: 30px;
            font-size: 2.8em;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        h1 i {
            font-size: 0.9em;
            color: var(--primary-color);
        }

        /* --- Table Styling --- */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 30px;
            margin-bottom: 30px;
            border-radius: var(--border-radius-md);
            overflow: hidden;
            box-shadow: 0 4px 15px var(--card-shadow);
        }

        th, td {
            border: 1px solid var(--timetable-cell-border);
            padding: 15px 10px;
            text-align: center;
            font-size: 0.95em;
            vertical-align: middle;
        }

        th {
            background-color: var(--timetable-header-bg);
            color: var(--timetable-header-text);
            font-weight: 600;
            font-family: 'Montserrat', sans-serif;
            white-space: nowrap;
            padding: 18px 10px;
        }

        th:first-child {
            border-top-left-radius: var(--border-radius-md);
        }
        th:last-child {
            border-top-right-radius: var(--border-radius-md);
        }
        
        tbody tr:nth-child(even) {
            background-color: var(--timetable-row-even-bg);
        }

        tbody tr:hover {
            background-color: var(--timetable-row-hover-bg);
            transition: background-color var(--transition-speed) ease;
        }

        td:first-child {
            font-weight: 500;
            background-color: var(--background-dark);
            color: var(--text-dark);
        }

        td:not(:first-child) {
            color: var(--primary-dark);
            font-weight: 500;
        }

        /* Generic Message Box Styling */
        .message-box {
            padding: 15px 20px;
            border-radius: var(--border-radius-sm);
            margin: 20px 0;
            text-align: center;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            opacity: 1;
            transition: opacity var(--transition-speed) ease-out, transform var(--transition-speed) ease-out;
        }

        .message-box.error {
            background-color: var(--error-bg);
            color: var(--error-text);
            border: 1px solid rgba(114, 28, 36, 0.2);
        }
        .message-box.error i {
            color: var(--error-text);
        }

        /* --- Action Buttons Container --- */
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .action-buttons button,
        .action-buttons .button-link { /* Added .button-link for anchor tags styled as buttons */
            padding: 12px 25px;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: background-color var(--transition-speed) ease, transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            text-decoration: none; /* For anchor tags */
            color: var(--text-light); /* For anchor tags */
            background-color: var(--primary-color); /* Default for new buttons */
        }

        .action-buttons button:hover,
        .action-buttons .button-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .action-buttons button:active,
        .action-buttons .button-link:active {
            transform: translateY(0);
            box-shadow: none;
        }

        .action-buttons button:disabled {
            background-color: var(--secondary-color);
            cursor: not-allowed;
            opacity: 0.7;
            transform: none;
            box-shadow: none;
        }

        .analyze-button {
            background-color: #6f42c1; /* Purple color for AI feature */
        }
        .analyze-button:hover {
            background-color: #5a359b;
        }

        .generate-button { /* Specific style for generate button */
            background-color: var(--primary-color);
        }
        .generate-button:hover {
            background-color: var(--primary-dark);
        }

        /* --- LLM Analysis Section --- */
        .llm-analysis-section {
            background-color: var(--background-light);
            padding: 30px;
            border-radius: var(--border-radius-md);
            box-shadow: 0 4px 15px var(--card-shadow);
            margin-top: 40px;
            border: 1px solid var(--border-color);
            display: none;
            animation: fadeIn var(--transition-speed) ease-out;
        }

        .llm-analysis-section h2 {
            color: var(--primary-color);
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8em;
            font-weight: 700;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .llm-analysis-section pre {
            background-color: var(--background-card);
            padding: 20px;
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--border-color);
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Roboto', monospace;
            font-size: 0.95em;
            line-height: 1.7;
            color: var(--text-dark);
        }

        .llm-analysis-section .loading-spinner {
            text-align: center;
            padding: 30px;
            font-size: 1.2em;
            color: var(--secondary-color);
        }
        .llm-analysis-section .loading-spinner i {
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }


        /* Back to Dashboard Link */
        .back-link {
            display: inline-flex;
            margin-top: 20px;
            padding: 12px 25px;
            background-color: var(--secondary-color);
            color: var(--text-light);
            text-decoration: none;
            border-radius: var(--border-radius-sm);
            transition: background-color var(--transition-speed) ease, transform 0.2s ease, box-shadow 0.2s ease;
            font-weight: 500;
            align-items: center;
            gap: 10px;
        }

        .back-link:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
        }

        .back-link:active {
            transform: translateY(0);
            box-shadow: none;
        }

        /* --- Responsive Design --- */
        @media (max-width: 992px) {
            .timetable-container {
                padding: 30px;
            }
            h1 {
                font-size: 2.5em;
            }
            th, td {
                padding: 12px 8px;
                font-size: 0.9em;
            }
            th {
                padding: 15px 8px;
            }
            .llm-analysis-section {
                padding: 25px;
            }
            .llm-analysis-section h2 {
                font-size: 1.6em;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            .timetable-container {
                width: 100%;
                padding: 25px;
                margin-top: 20px;
                margin-bottom: 20px;
            }
            h1 {
                font-size: 2em;
                flex-direction: column;
                gap: 8px;
                margin-bottom: 25px;
            }
            h1 i {
                font-size: 0.8em;
            }
            table {
                font-size: 0.9em;
            }
            th, td {
                padding: 10px 5px;
                white-space: normal;
            }
            th:first-child, th:last-child {
                border-radius: 0;
            }
            .message-box {
                padding: 12px 15px;
                font-size: 0.9em;
                margin: 15px 0;
            }
            .action-buttons {
                flex-direction: column;
                gap: 15px;
            }
            .action-buttons button,
            .action-buttons .button-link {
                width: 100%;
                justify-content: center;
            }
            .llm-analysis-section {
                padding: 20px;
            }
            .llm-analysis-section h2 {
                font-size: 1.4em;
            }
            .llm-analysis-section pre {
                font-size: 0.9em;
                padding: 15px;
            }
            .back-link {
                padding: 10px 20px;
                font-size: 0.95em;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            .timetable-container {
                padding: 15px;
            }
            h1 {
                font-size: 1.8em;
            }
            th, td {
                padding: 8px 4px;
                font-size: 0.8em;
            }
            .back-link {
                font-size: 0.9em;
                padding: 8px 15px;
            }
        }
    </style>
</head>
<body>
    <div class="timetable-container">
        <h1><i class="fas fa-calendar-alt"></i> Generated Timetable</h1>
        
        {% if error_message %}
            <div id="status-message" class="message-box error">
                <i class="fas fa-exclamation-circle"></i> {{ error_message }}
            </div>
        {% endif %}

        <div class="action-buttons">
            <button id="generateTimetableNowBtn" class="generate-button" onclick="generateTimetableClient()">
                <i class="fas fa-sync-alt"></i> Generate New Timetable
            </button>
            <button id="analyzeTimetableBtn" class="analyze-button" onclick="analyzeTimetable()" {% if not timetable %}disabled{% endif %}>
                <i class="fas fa-magic"></i> Analyze Timetable âœ¨
            </button>
            <a href="{{ url_for('export_timetable') }}" class="button-link generate-button"> <i class="fas fa-file-excel"></i> Export to Excel
            </a>
        </div>

        <div id="timetableDisplayArea">
            {% if timetable %}
                <table>
                    <thead>
                        <tr>
                            <th>Class</th>
                            <th>Period 1</th>
                            <th>Period 2</th>
                            <th>Period 3</th>
                            <th>Period 4</th>
                            <th>Period 5</th>
                        </tr>
                    </thead>
                    <tbody id="timetableBody">
                        {% for class_name, teachers in timetable.items() %}
                        <tr>
                            <td>{{ class_name }}</td>
                            {% for teacher in teachers %}
                            <td>{{ teacher }}</td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p id="noTimetableMessage" style="text-align: center; padding: 25px; background-color: var(--background-light); border-radius: var(--border-radius-md); color: var(--secondary-color); border: 1px dashed var(--border-color);">
                    <i class="fas fa-info-circle" style="margin-right: 8px;"></i> No timetable generated yet. Click "Generate New Timetable" above.
                </p>
            {% endif %}
        </div>

        <div id="llmAnalysis" class="llm-analysis-section" style="display: none;">
            <h2><i class="fas fa-brain"></i> Timetable Analysis from AI</h2>
            <div id="analysisContent">
                <div class="loading-spinner" style="display: none;">
                    <i class="fas fa-spinner"></i> Generating analysis...
                </div>
                <pre id="analysisText"></pre>
            </div>
        </div>

        <a href="{{ url_for('dashboard') }}" class="back-link">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
    </div>

    <script>
        // Helper function to show status messages
        function showStatusMessage(message, type = 'error') {
            let statusMessageDiv = document.getElementById('status-message');
            if (!statusMessageDiv) {
                statusMessageDiv = document.createElement('div');
                statusMessageDiv.id = 'status-message';
                document.querySelector('.timetable-container').prepend(statusMessageDiv);
            }
            statusMessageDiv.className = `message-box ${type}`;
            statusMessageDiv.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${message}`;
            statusMessageDiv.style.display = 'flex';
            statusMessageDiv.style.opacity = '1';
            statusMessageDiv.style.transform = 'translateY(0)';

            setTimeout(() => {
                statusMessageDiv.style.opacity = '0';
                statusMessageDiv.style.transform = 'translateY(-10px)';
                setTimeout(() => {
                    statusMessageDiv.style.display = 'none';
                }, 500);
            }, 4000);
        }

        // Function to generate timetable
        async function generateTimetableClient() {
            const generateBtn = document.getElementById('generateTimetableNowBtn');
            const analyzeBtn = document.getElementById('analyzeTimetableBtn');
            const timetableDisplayArea = document.getElementById('timetableDisplayArea');
            const llmAnalysisSection = document.getElementById('llmAnalysis');
            const noTimetableMessage = document.getElementById('noTimetableMessage'); // Get the message element

            // Show loading state
            generateBtn.disabled = true;
            analyzeBtn.disabled = true; // Disable analyze button during generation
            llmAnalysisSection.style.display = 'none'; // Hide analysis if visible
            
            // Display a loading message or spinner in the timetable area
            timetableDisplayArea.innerHTML = `
                <p style="text-align: center; padding: 30px; color: var(--secondary-color);">
                    <i class="fas fa-spinner fa-spin" style="margin-right: 10px;"></i> Generating timetable... This might take a moment.
                </p>
            `;

            try {
                const response = await fetch('{{ url_for("generate_timetable_process") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (response.ok) {
                    const timetable = result.timetable;
                    const successMessage = result.success_message;

                    // Clear existing timetable content
                    timetableDisplayArea.innerHTML = ''; 

                    // Re-create table structure
                    const tableHtml = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Class</th>
                                    <th>Period 1</th>
                                    <th>Period 2</th>
                                    <th>Period 3</th>
                                    <th>Period 4</th>
                                    <th>Period 5</th>
                                </tr>
                            </thead>
                            <tbody id="timetableBody">
                                </tbody>
                        </table>
                    `;
                    timetableDisplayArea.innerHTML = tableHtml;
                    const timetableBody = document.getElementById('timetableBody');

                    // Populate table with generated data
                    for (const className in timetable) {
                        const row = document.createElement('tr');
                        const classCell = document.createElement('td');
                        classCell.textContent = className;
                        row.appendChild(classCell);

                        timetable[className].forEach(teacher => {
                            const teacherCell = document.createElement('td');
                            teacherCell.textContent = teacher || 'N/A'; // Handle potential nulls
                            row.appendChild(teacherCell);
                        });
                        timetableBody.appendChild(row);
                    }
                    showStatusMessage(successMessage, 'success');
                    analyzeBtn.disabled = false; // Enable analyze button after successful generation

                } else {
                    throw new Error(result.error || 'Failed to generate timetable.');
                }
            } catch (error) {
                console.error('Error generating timetable:', error);
                timetableDisplayArea.innerHTML = `
                    <p style="text-align: center; padding: 30px; color: var(--error-text);">
                        <i class="fas fa-times-circle" style="margin-right: 10px;"></i> Error: ${error.message}
                    </p>
                `;
                showStatusMessage(`Error: ${error.message}`, 'error');
                analyzeBtn.disabled = true; // Keep analyze button disabled on generation error
            } finally {
                generateBtn.disabled = false; // Re-enable generate button
            }
        }

        // Function to analyze timetable using LLM (existing)
        async function analyzeTimetable() {
            // Ensure timetable is available before attempting analysis
            const timetableBody = document.getElementById('timetableBody');
            if (!timetableBody || timetableBody.rows.length === 0) {
                showStatusMessage("No timetable data to analyze. Please generate a timetable first.", 'error');
                return;
            }

            // Extract timetable data from the DOM (or use the original Jinja data if still available)
            // For robustness, let's extract from the DOM if possible, or use the initial Jinja data.
            // If the page was reloaded, the Jinja data ({{ timetable | tojson | safe }}) will be the initial data.
            // If it was dynamically generated, we need to reconstruct it from the table.
            let currentTimetableData = {};
            const tableRows = timetableBody.querySelectorAll('tr');
            tableRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length > 0) {
                    const className = cells[0].textContent;
                    const teachers = [];
                    for (let i = 1; i < cells.length; i++) {
                        teachers.push(cells[i].textContent);
                    }
                    currentTimetableData[className] = teachers;
                }
            });

            const analyzeBtn = document.getElementById('analyzeTimetableBtn');
            const llmAnalysisSection = document.getElementById('llmAnalysis');
            const analysisText = document.getElementById('analysisText');
            const loadingSpinner = llmAnalysisSection.querySelector('.loading-spinner');

            // Show analysis section and loading spinner
            llmAnalysisSection.style.display = 'block';
            analysisText.textContent = ''; // Clear previous analysis
            loadingSpinner.style.display = 'block';
            analyzeBtn.disabled = true; // Disable button during analysis

            try {
                const response = await fetch('{{ url_for("analyze_timetable") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ timetable: currentTimetableData }) // Use extracted data
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to fetch analysis from server.');
                }

                const result = await response.json();
                analysisText.textContent = result.analysis; // Display the analysis
            } catch (error) {
                console.error('Error analyzing timetable:', error);
                analysisText.textContent = `Error: ${error.message}. Please try again.`;
                analysisText.style.color = 'var(--error-text)';
                showStatusMessage(`Analysis Error: ${error.message}`, 'error');
            } finally {
                loadingSpinner.style.display = 'none'; // Hide loading spinner
                analyzeBtn.disabled = false; // Re-enable button
            }
        }

        // Initial check for timetable presence to manage analyze button state
        document.addEventListener('DOMContentLoaded', function() {
            const analyzeBtn = document.getElementById('analyzeTimetableBtn');
            const timetableBody = document.getElementById('timetableBody');
            if (!timetableBody || timetableBody.rows.length === 0) {
                analyzeBtn.disabled = true;
            } else {
                analyzeBtn.disabled = false;
            }
        });

        // Hide status message after a few seconds (existing)
        document.addEventListener('DOMContentLoaded', function() {
            const statusMessage = document.getElementById('status-message');
            if (statusMessage && statusMessage.textContent.trim() !== '') {
                statusMessage.style.display = 'flex';
                statusMessage.style.opacity = '1';
                statusMessage.style.transform = 'translateY(0)';

                setTimeout(() => {
                    statusMessage.style.opacity = '0';
                    statusMessage.style.transform = 'translateY(-10px)';
                    setTimeout(() => {
                        statusMessage.style.display = 'none';
                    }, 500);
                }, 4000);
            }
        });
    </script>
</body>
</html>
